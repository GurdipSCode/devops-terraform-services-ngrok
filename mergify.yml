# .mergify.yml
# Mergify configuration for OpenTofu Module repositories

queue_rules:
  - name: default
    merge_method: squash
    update_method: rebase
    commit_message_template: |
      {{ title }} (#{{ number }})

      {{ body | get_section("## Summary", "---") }}

      {% for commit in commits %}
      - {{ commit.commit_message }}
      {% endfor %}

pull_request_rules:
  # ============================================================================
  # üöÄ AUTO-MERGE RULES
  # ============================================================================

  # Auto-merge when approved and all checks pass
  - name: üöÄ Auto-merge when approved
    conditions:
      - "#approved-reviews-by >= 1"
      - "#changes-requested-reviews-by = 0"
      - check-success = terraform-fmt
      - check-success = terraform-validate
      - check-success = tflint
      - check-success = trivy-scan
      - check-success = checkov-scan
      - -draft
      - -closed
      - label != do-not-merge
      - label != wip
    actions:
      queue:
        name: default

  # Auto-merge Dependabot PRs (patch versions)
  - name: ü§ñ Auto-merge Dependabot (patch)
    conditions:
      - author = dependabot[bot]
      - "title ~= ^chore\\(deps\\):"
      - "body ~= bump.*from.*to"
      - check-success = terraform-fmt
      - check-success = terraform-validate
      - check-success = trivy-scan
      - -closed
      - label != do-not-merge
    actions:
      review:
        type: APPROVE
        message: "ü§ñ Auto-approved patch dependency update"
      queue:
        name: default

  # Auto-merge Renovate PRs (patch versions)
  - name: ü§ñ Auto-merge Renovate (patch)
    conditions:
      - author = renovate[bot]
      - "title ~= ^chore\\(deps\\):"
      - check-success = terraform-fmt
      - check-success = terraform-validate
      - check-success = trivy-scan
      - -closed
      - label != do-not-merge
    actions:
      review:
        type: APPROVE
        message: "ü§ñ Auto-approved patch dependency update"
      queue:
        name: default

  # ============================================================================
  # üè∑Ô∏è AUTO-LABELING RULES
  # ============================================================================

  # Label: terraform changes
  - name: üè∑Ô∏è Label terraform changes
    conditions:
      - "files ~= \\.tf$"
    actions:
      label:
        add:
          - terraform
          - needs-review

  # Label: documentation changes
  - name: üè∑Ô∏è Label documentation
    conditions:
      - "files ~= \\.(md|txt)$"
    actions:
      label:
        add:
          - documentation

  # Label: CI/CD changes
  - name: üè∑Ô∏è Label CI changes
    conditions:
      - or:
          - "files ~= \\.buildkite/"
          - "files ~= \\.github/"
          - "files ~= \\.mergify\\.yml"
    actions:
      label:
        add:
          - ci-cd

  # Label: examples changes
  - name: üè∑Ô∏è Label examples
    conditions:
      - "files ~= ^examples/"
    actions:
      label:
        add:
          - examples

  # Label: module changes
  - name: üè∑Ô∏è Label modules
    conditions:
      - "files ~= ^modules/"
    actions:
      label:
        add:
          - submodule

  # Label: breaking changes
  - name: üè∑Ô∏è Label breaking changes
    conditions:
      - or:
          - "title ~= ^.*!:"
          - "body ~= BREAKING.CHANGE"
    actions:
      label:
        add:
          - breaking-change
          - major

  # Label: features
  - name: üè∑Ô∏è Label features
    conditions:
      - "title ~= ^feat(\\(.*\\))?:"
    actions:
      label:
        add:
          - feature
          - minor

  # Label: bug fixes
  - name: üè∑Ô∏è Label bug fixes
    conditions:
      - "title ~= ^fix(\\(.*\\))?:"
    actions:
      label:
        add:
          - bug
          - patch

  # Label: security
  - name: üè∑Ô∏è Label security
    conditions:
      - or:
          - "title ~= ^sec(\\(.*\\))?:"
          - "title ~= security"
          - "files ~= ^security/"
    actions:
      label:
        add:
          - security
          - priority-high

  # Label: size
  - name: üè∑Ô∏è Label size/XS
    conditions:
      - "#files <= 3"
      - "#lines-changed <= 30"
    actions:
      label:
        add:
          - size/XS

  - name: üè∑Ô∏è Label size/S
    conditions:
      - "#files <= 5"
      - "#lines-changed > 30"
      - "#lines-changed <= 100"
    actions:
      label:
        add:
          - size/S

  - name: üè∑Ô∏è Label size/M
    conditions:
      - "#lines-changed > 100"
      - "#lines-changed <= 300"
    actions:
      label:
        add:
          - size/M

  - name: üè∑Ô∏è Label size/L
    conditions:
      - "#lines-changed > 300"
      - "#lines-changed <= 500"
    actions:
      label:
        add:
          - size/L

  - name: üè∑Ô∏è Label size/XL
    conditions:
      - "#lines-changed > 500"
    actions:
      label:
        add:
          - size/XL
          - needs-split

  # ============================================================================
  # ‚ö†Ô∏è WARNING & NOTIFICATION RULES
  # ============================================================================

  # Warn about missing description
  - name: ‚ö†Ô∏è Warn missing description
    conditions:
      - "body = ''"
      - -draft
    actions:
      comment:
        message: |
          ‚ö†Ô∏è **Missing PR Description**

          Please add a description to help reviewers understand your changes.

          Consider including:
          - What changes are being made
          - Why these changes are needed
          - How to test the changes

  # Warn about large PRs
  - name: ‚ö†Ô∏è Warn large PR
    conditions:
      - "#lines-changed > 500"
      - -draft
    actions:
      comment:
        message: |
          ‚ö†Ô∏è **Large PR Detected** (`{{ lines_changed }}` lines changed)

          Consider splitting this PR into smaller, focused changes for easier review.

          Large PRs are harder to review and more likely to introduce bugs.

  # Warn about breaking changes
  - name: ‚ö†Ô∏è Warn breaking changes
    conditions:
      - or:
          - "title ~= ^.*!:"
          - "body ~= BREAKING.CHANGE"
      - -draft
    actions:
      comment:
        message: |
          ‚ö†Ô∏è **Breaking Change Detected**

          This PR contains breaking changes. Please ensure:
          - [ ] Migration guide is documented in PR description
          - [ ] CHANGELOG is updated
          - [ ] Major version bump is appropriate
          - [ ] All examples are updated
          - [ ] Documentation reflects the changes

  # Warn about state file changes
  - name: üö® Block state files
    conditions:
      - "files ~= \\.tfstate"
    actions:
      comment:
        message: |
          üö® **State File Detected**

          This PR contains Terraform state files which should **NEVER** be committed.
          State files contain sensitive information.

          Please remove these files and add them to `.gitignore`.
      label:
        add:
          - security-issue
          - do-not-merge

  # Warn about .terraform directory
  - name: üö® Block .terraform directory
    conditions:
      - "files ~= \\.terraform/"
    actions:
      comment:
        message: |
          üö® **`.terraform` Directory Detected**

          This PR contains files from the `.terraform` directory which should not be committed.

          Please remove these files and ensure `.terraform/` is in your `.gitignore`.
      label:
        add:
          - do-not-merge

  # ============================================================================
  # üîÑ HOUSEKEEPING RULES
  # ============================================================================

  # Remove stale reviews when updated
  - name: üîÑ Remove stale reviews
    conditions:
      - base = main
    actions:
      dismiss_reviews:
        changes_requested: true
        approved: true
        message: "PR was updated, dismissing stale reviews"

  # Auto-close stale PRs
  - name: üßπ Close stale PRs
    conditions:
      - -closed
      - updated-at < 30 days ago
      - -draft
      - label = stale
    actions:
      close:
        message: |
          üßπ This PR has been automatically closed due to inactivity.

          Feel free to reopen if you'd like to continue working on it.

  # Mark as stale after 14 days
  - name: üè∑Ô∏è Mark stale
    conditions:
      - -closed
      - -draft
      - updated-at < 14 days ago
      - -label = stale
      - -label = do-not-merge
    actions:
      label:
        add:
          - stale
      comment:
        message: |
          ‚è∞ This PR has been marked as **stale** due to 14 days of inactivity.

          It will be automatically closed in 30 days if there's no further activity.

  # Remove stale label on activity
  - name: üîÑ Remove stale on activity
    conditions:
      - label = stale
      - updated-at < 1 days ago
    actions:
      label:
        remove:
          - stale

  # Auto-delete merged branches
  - name: üóëÔ∏è Delete merged branches
    conditions:
      - merged
    actions:
      delete_head_branch:

  # ============================================================================
  # üìã REVIEWER ASSIGNMENT
  # ============================================================================

  # Request review for terraform changes
  - name: üìã Request reviewers for terraform
    conditions:
      - "files ~= \\.tf$"
      - -draft
      - "#approved-reviews-by = 0"
      - -closed
    actions:
      request_reviews:
        teams:
          - platform-team
        random_count: 2

  # Request security review
  - name: üìã Request security review
    conditions:
      - label = security
      - -draft
      - -closed
    actions:
      request_reviews:
        teams:
          - security-team

  # ============================================================================
  # ‚úÖ VALIDATION RULES
  # ============================================================================

  # Require conventional commit title
  - name: ‚úÖ Require conventional commit
    conditions:
      - -draft
      - -closed
      - "title !~= ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\\(.*\\))?!?:"
    actions:
      comment:
        message: |
          ‚ùå **Invalid PR Title**

          Please use [Conventional Commits](https://www.conventionalcommits.org/) format:

          ```
          <type>(<scope>): <description>
          ```

          **Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`

          **Examples:**
          - `feat(datasets): add retention policy support`
          - `fix(monitors): correct threshold validation`
          - `docs(readme): update usage examples`
          - `feat!: rename variables input to datasets` (breaking change)
      label:
        add:
          - invalid-title
